package com.zhd.exploit.api.service.impl;

import static com.zhd.exploit.api.utils.StringUtils.isEmpty;

import java.util.Date;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.zhd.exploit.api.dto.BizException;
import com.zhd.exploit.api.dto.PayDTO;
import com.zhd.exploit.api.dto.RspPayDTO;
import com.zhd.exploit.api.dto.RspQueryDTO;
import com.zhd.exploit.api.entity.CpUserInfo;
import com.zhd.exploit.api.entity.PayLog;
import com.zhd.exploit.api.entity.Payqrcode;
import com.zhd.exploit.api.enums.PayErrorCode;
import com.zhd.exploit.api.enums.PayState;
import com.zhd.exploit.api.mapper.CpUserInfoMapper;
import com.zhd.exploit.api.mapper.PayLogMapper;
import com.zhd.exploit.api.mapper.PayqrcodeMapper;
import com.zhd.exploit.api.service.PayService;
import com.zhd.exploit.api.utils.DateUtils;
import com.zhd.exploit.api.utils.MD5Utill;

@Service
public class PayServiceImpl implements PayService {
	@Autowired
	private CpUserInfoMapper cpUserInfoMapper;
	@Autowired
	private PayLogMapper payLogMapper;
	@Autowired
	private PayqrcodeMapper payqrcodeMapper;

	@Override
	public RspPayDTO pay(PayDTO payDTO) {
		// TODO 校验参数
		checkParams(payDTO);
		// 支付路由获取支付二维码
		Payqrcode payqrcode = getQrcode(Integer.valueOf(payDTO.getAppmount()));
		if (payqrcode != null) {
			RspPayDTO rspPayDTO = PayErrorCode.SUCCESS.transPayDTO();
			rspPayDTO.setCporderno(payDTO.getCporderno());
			rspPayDTO.setMerchantid(payDTO.getMerchantid());
			rspPayDTO.setQrcode(payqrcode.getQrcode());
			savePaylog(payDTO, payqrcode.getCodeid());
			return rspPayDTO;
		} else {
			return PayErrorCode.NO_PAY_CHANNEL.transPayDTO();
		}
	}

	private void savePaylog(PayDTO payDTO, Integer qrcodeid) {
		try {
			PayLog payLog = new PayLog();
			payLog.setCreatetime(new Date());
			payLog.setAppmount(Integer.valueOf(payDTO.getAppmount()));
			payLog.setCporderno(payDTO.getCporderno());
			payLog.setMerchantid(payDTO.getMerchantid());
			payLog.setNotifyurl(payDTO.getNotifyurl());
			payLog.setPaytype(payDTO.getPaytype());
			payLog.setSubject(payDTO.getSubject());
			payLog.setTransdata(payDTO.getTransdata());
			payLog.setQrcodeid(qrcodeid);
			payLog.setPaystate(PayState.NO_RESULT.getCode());
			payLogMapper.insert(payLog);
		} catch (Exception e) {
			e.printStackTrace();
		}
	}

	/**
	 * 根据金额随机查询一条可用二维码
	 * 
	 * @param appmount
	 * @return
	 */
	private synchronized Payqrcode getQrcode(Integer appmount) {
		// TODO 根据支付方式、价格 获取可取收款二维码
		Payqrcode payqrcode = payqrcodeMapper.queryRandomByPrice(appmount);
		if (payqrcode != null) {
			Payqrcode record = new Payqrcode();
			record.setCodeid(payqrcode.getCodeid());
			record.setStatus("0");// 设置为不可用
			record.setUpdatetime(new Date());
			payqrcodeMapper.updateByPrimaryKeySelective(record);
			return payqrcode;
		}
		return null;
	}

	private void checkParams(PayDTO payDTO) {
		String merchantid = payDTO.getMerchantid();
		String cporderno = payDTO.getCporderno();
		String appmount = payDTO.getAppmount();
		String sign = payDTO.getSign();
		if (isEmpty(merchantid)) {
			throw new BizException(PayErrorCode.PARAM_NOT_COMPLETE.getCode(), PayErrorCode.PARAM_NOT_COMPLETE.getNewDesc("merchantid"));
		}
		if (isEmpty(cporderno)) {
			throw new BizException(PayErrorCode.PARAM_NOT_COMPLETE.getCode(), PayErrorCode.PARAM_NOT_COMPLETE.getNewDesc("cporderno"));
		}
		if (isEmpty(appmount)) {
			throw new BizException(PayErrorCode.PARAM_NOT_COMPLETE.getCode(), PayErrorCode.PARAM_NOT_COMPLETE.getNewDesc("appmount"));
		}
		if (isEmpty(sign)) {
			throw new BizException(PayErrorCode.PARAM_NOT_COMPLETE.getCode(), PayErrorCode.PARAM_NOT_COMPLETE.getNewDesc("sign"));
		}
		CpUserInfo cpUserInfo = cpUserInfoMapper.queryByMerchantid(merchantid);
		if (cpUserInfo == null) {
			throw new BizException(PayErrorCode.ERR_MERCHANTID);
		}
		PayLog payLog = payLogMapper.selectByKey(merchantid, cporderno);
		if (payLog != null) {
			throw new BizException(PayErrorCode.REPEAT_CPORDERNO);
		}
		try {
			if (Integer.valueOf(appmount) <= 0) {
				throw new BizException(PayErrorCode.ERR_AMOUNT);
			}
		} catch (Exception e) {
			throw new BizException(PayErrorCode.ERR_AMOUNT);
		}
		// 验签
		StringBuffer buffer = new StringBuffer();
		buffer.append(merchantid).append("|").append(cporderno).append("|");
		buffer.append(appmount).append("|").append(cpUserInfo.getMd5key());
		String signData = buffer.toString();
		String hexString = MD5Utill.toHexString(MD5Utill.md5(signData));
		if (!hexString.equals(sign)) {
			throw new BizException(PayErrorCode.ERR_SIGN);
		}
	}

	@Override
	public RspQueryDTO queryResult(PayDTO payDTO) {
		String merchantid = payDTO.getMerchantid();
		String cporderno = payDTO.getCporderno();
		String sign = payDTO.getSign();
		if (isEmpty(merchantid) || isEmpty(cporderno) || isEmpty(sign)) {
			return new RspQueryDTO(PayErrorCode.PARAM_NOT_COMPLETE);
		}
		CpUserInfo cpUserInfo = cpUserInfoMapper.queryByMerchantid(merchantid);
		if (cpUserInfo == null) {
			return new RspQueryDTO(PayErrorCode.ERR_MERCHANTID);
		}
		// 验签
		StringBuffer buffer = new StringBuffer();
		buffer.append(merchantid).append("|").append(cporderno).append("|").append(cpUserInfo.getMd5key());
		String signData = buffer.toString();
		String hexString = MD5Utill.toHexString(MD5Utill.md5(signData));
		if (!hexString.equals(sign)) {
			return new RspQueryDTO(PayErrorCode.ERR_SIGN);
		}
		PayLog payLog = payLogMapper.selectByKey(merchantid, cporderno);
		if (payLog == null) {
			return new RspQueryDTO(PayState.NO_RESULT);
		}
		String paystate = payLog.getPaystate();
		RspQueryDTO rspQueryDTO = new RspQueryDTO(paystate);
		try {
			String paytime = DateUtils.format(DateUtils.secondFormat, payLog.getPaytime());
			rspQueryDTO.setPaytime(paytime);
		} catch (Exception e) {
		}
		return rspQueryDTO;
	}

}
